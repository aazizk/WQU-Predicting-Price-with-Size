import warnings
from glob import glob

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import wqet_grader
from category_encoders import OneHotEncoder
from IPython.display import VimeoVideo
from ipywidgets import Dropdown, FloatSlider, IntSlider, interact
from sklearn.impute import SimpleImputer
from sklearn.linear_model import LinearRegression, Ridge  # noqa F401
from sklearn.metrics import mean_absolute_error
from sklearn.pipeline import make_pipeline
from sklearn.utils.validation import check_is_fitted

warnings.simplefiltdef wrangle(filepath):

def wrangle(filepath):
    # Read CSV file
    df = pd.read_csv(filepath)

    # Subset data: Apartments in "Capital Federal", less than 400,000
    mask_ba = df["place_with_parent_names"].str.contains("Distrito Federal")
    mask_apt = df["property_type"] == "apartment"
    mask_price = df["price_aprox_usd"] < 100_000
    df = df[mask_ba & mask_apt & mask_price]

    # Subset data: Remove outliers for "surface_covered_in_m2"
    low, high = df["surface_covered_in_m2"].quantile([0.1, 0.9])
    mask_area = df["surface_covered_in_m2"].between(low, high)
    df = df[mask_area]

    # Split "lat-lon" column
    df[["lat", "lon"]] = df["lat-lon"].str.split(",", expand=True).astype(float)
#    df.drop(columns="lat-lon", inplace=True) Added in below drop code

    # Get place name
    df["borough"] = df["place_with_parent_names"].str.split("|", expand=True)[1]
    df.drop(columns=["place_with_parent_names", "lat-lon"], inplace=True)#dropping lat-lon and place with parent name
    df.drop(columns=["surface_total_in_m2", "floor", "rooms", "expenses", "price_usd_per_m2"], inplace=True) #dropping null values
    df.drop(columns=["operation", "property_type", "currency", "properati_url"], inplace=True) #drop low and high cadinality columns
    df.drop(columns=["price", "price_aprox_local_currency", "price_per_m2"], inplace=True) #drop leakage
#    df.drop(columns=["surface_total_in_m2", "rooms"], inplace=True) #drop multicollinearity columns
    return df

# Use this cell to test your wrangle function and explore the data
file = "data/mexico-city-real-estate-1.csv"
df = wrangle(file)
df.info()
    
#Data exploration commands
df.select_dtypes("object").head()
df.select_dtypes("object").nunique #checking low and high cadinality
df.isnull().sum() / len(df) # checking nulls
sorted(df.columns) # to check leakage
corr = df.select_dtypes("number").drop(columns = "price_aprox_usd").corr()
sns.heatmap(corr) # heatmap to check multi-colinearity

files = glob(("data/mexico-city-real-estate-*.csv"))
files

frames = [wrangle(file) for file in files]
df = pd.concat(frames, ignore_index = True)
print(df.info())
df.head()

# Plot distribution of price
plt.hist(df["price_aprox_usd"])
plt.xlabel("Area [sq meters]")
plt.ylabel("Count")
plt.title("Distribution of Apartment Prices");
# Don't delete the code below ðŸ‘‡
plt.savefig("images/2-5-4.png", dpi=150)

